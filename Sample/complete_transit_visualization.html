<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gujarat Transit Routes - Real Data Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="corrected_coordinates_database.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        .route-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .route-marker:hover {
            transform: scale(1.5);
            z-index: 1000;
        }
        .city-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .city-marker:hover {
            transform: scale(1.3);
            z-index: 100;
        }
        .info-window-content {
            min-width: 200px;
            padding: 10px;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-4xl font-bold text-center">üöå Gujarat Transit Routes Map</h1>
            <p class="text-center mt-2 text-blue-100">Real-time visualization of 1184+ transportation routes from unified JSON data</p>
        </div>
    </header>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md">
            <div class="loading w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded mx-auto mb-4"></div>
            <p class="text-gray-700 text-center mb-3 font-semibold">Processing Transit Data</p>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="loading-status" class="text-sm text-gray-500 text-center mt-2">Starting...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8" id="dashboard" style="display: none;">
        
        <!-- Statistics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card text-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Total Routes</p>
                        <p id="total-routes" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="text-4xl opacity-80">üöå</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Ahmedabad</p>
                        <p id="amd-count" class="text-2xl font-bold text-blue-600">0</p>
                        <p class="text-xs text-gray-500">AMTS + BRT</p>
                    </div>
                    <div class="text-3xl">üè¢</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Rajkot</p>
                        <p id="rjkt-count" class="text-2xl font-bold text-green-600">0</p>
                        <p class="text-xs text-gray-500">BRT Routes</p>
                    </div>
                    <div class="text-3xl">üåÜ</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Surat</p>
                        <p id="srt-count" class="text-2xl font-bold text-purple-600">0</p>
                        <p class="text-xs text-gray-500">BRT + City</p>
                    </div>
                    <div class="text-3xl">üè≠</div>
                </div>
            </div>
        </div>

        <!-- Map and Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Map Section -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-700">üó∫Ô∏è Interactive Route Map</h3>
                        <div class="flex gap-3">
                            <button id="toggle-amd" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" data-city="amd">
                                Ahmedabad
                            </button>
                            <button id="toggle-rjkt" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" data-city="rjkt">
                                Rajkot
                            </button>
                            <button id="toggle-srt" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors" data-city="srt">
                                Surat
                            </button>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="map"></div>
                    
                    <!-- Map Controls Overlay -->
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex gap-2">
                            <button id="map-type-roadmap" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">Roadmap</button>
                            <button id="map-type-satellite" class="px-3 py-1 bg-gray-500 text-white rounded text-sm">Satellite</button>
                            <button id="map-type-terrain" class="px-3 py-1 bg-gray-500 text-white rounded text-sm">Terrain</button>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span id="visible-routes-count">0</span> routes visible
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Route Details -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üìã Route Details</h3>
                    <div id="route-details" class="text-sm text-gray-600">
                        <div class="text-center py-8">
                            <div class="text-4xl mb-3">üöå</div>
                            <p class="text-gray-500">Click on any city or route to see details</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üìä Quick Stats</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span>BRT Routes:</span>
                            <span id="brt-count" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>AMTS Routes:</span>
                            <span id="amts-count" class="font-bold text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>City Bus Routes:</span>
                            <span id="city-count" class="font-bold text-purple-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Service Coverage:</span>
                            <span class="font-bold text-green-600">24/7</span>
                        </div>
                    </div>
                </div>

                <!-- Service Types -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üöç Service Types</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span>Bus Rapid Transit (BRT)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span>Ahmedabad Municipal Transport</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            <span>City Bus Services</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Database Table -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-700">üìã Complete Route Database</h3>
                <div class="flex gap-4">
                    <input type="text" id="search-routes" placeholder="üîç Search routes..." 
                           class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="city-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Cities</option>
                        <option value="amd">Ahmedabad</option>
                        <option value="rjkt">Rajkot</option>
                        <option value="srt">Surat</option>
                    </select>
                </div>
            </div>
            
            <div class="data-table">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">City</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">From</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">To</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timing</th>
                        </tr>
                    </thead>
                    <tbody id="route-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Routes will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <span id="pagination-info" class="text-sm text-gray-600">Loading routes...</span>
                    <select id="routes-per-page" class="border border-gray-300 rounded px-3 py-1 text-sm" onchange="changeRoutesPerPage(this.value)">
                        <option value="25">25 per page</option>
                        <option value="50" selected>50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="all">Show all</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="prev-page" onclick="previousPage()" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    
                    <div id="page-numbers" class="flex items-center">
                        <!-- Page numbers will be generated here -->
                    </div>
                    
                    <button id="next-page" onclick="nextPage()" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let map;
        let markers = [];
        let routeMarkers = [];
        let allRoutes = [];
        let visibleCities = ['amd', 'rjkt', 'srt'];
        let infoWindow;
        let directionsService;
        let directionsRenderer;
        let currentSelectedRoute = null;
        let routeStationMarkers = [];
        let routePolyline = null;
        let highlightedRoute = null;

        // City configuration with precise coordinates
        const cityConfig = {
            amd: { 
                name: 'Ahmedabad', 
                color: '#3B82F6', 
                lat: 23.0225, 
                lng: 72.5714,
                routes: []
            },
            rjkt: { 
                name: 'Rajkot', 
                color: '#10B981', 
                lat: 22.3039, 
                lng: 70.8022,
                routes: []
            },
            srt: { 
                name: 'Surat', 
                color: '#8B5CF6', 
                lat: 21.1702, 
                lng: 72.8311,
                routes: []
            }
        };

        // Initialize Google Maps
        function initMap() {
            // Create map centered on Gujarat
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: { lat: 22.5, lng: 71.5 },
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: 'transit',
                        elementType: 'all',
                        stylers: [{ visibility: 'simplified' }]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'all',
                        stylers: [{ visibility: 'on' }]
                    }
                ]
            });

            // Initialize info window
            infoWindow = new google.maps.InfoWindow();

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true, // We'll add our own markers
                polylineOptions: {
                    strokeColor: '#FF0000',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            directionsRenderer.setMap(map);

            // Create city markers
            createCityMarkers();

            // Setup map controls
            setupMapControls();

            // Load transit data after map is ready
            parseAllData();
        }

        // Create markers for each city
        function createCityMarkers() {
            Object.keys(cityConfig).forEach(cityCode => {
                const city = cityConfig[cityCode];
                
                const marker = new google.maps.Marker({
                    position: { lat: city.lat, lng: city.lng },
                    map: map,
                    title: city.name + ' Transit System',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: city.color,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });

                marker.addListener('click', () => {
                    focusCity(cityCode);
                    showCityInfo(cityCode, marker);
                });

                markers.push({ marker, city: cityCode });
            });
        }

        // Show city information in info window
        function showCityInfo(cityCode, marker) {
            const city = cityConfig[cityCode];
            const cityRoutes = allRoutes.filter(r => r.city === cityCode);
            
            const content = `
                <div class="info-window-content">
                    <h3 class="font-bold text-lg text-gray-800">${city.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">Transit System Overview</p>
                    <div class="space-y-1 text-sm">
                        <p><strong>Total Routes:</strong> ${cityRoutes.length}</p>
                        <p><strong>Service Types:</strong> ${[...new Set(cityRoutes.map(r => r.type))].join(', ')}</p>
                        <p><strong>Operating Hours:</strong> 05:00 - 23:00</p>
                        <button onclick="zoomToCity('${cityCode}')" 
                                class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                            View Routes
                        </button>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        // Zoom to specific city
        function zoomToCity(cityCode) {
            const city = cityConfig[cityCode];
            map.setCenter({ lat: city.lat, lng: city.lng });
            map.setZoom(12);
            
            // Show route markers for this city
            showCityRoutes(cityCode);
        }

        // Station coordinate mapping and geocoding
        const stationCoordinates = {};
        const geocodingCache = new Map();
        
        // Manual mapping for key stations (Real Google Maps coordinates)
        const manualStationMapping = {
            // Ahmedabad AMTS & BRT Stations - Verified Google Maps Coordinates
            'Lal Darwaja': { lat: 23.0225, lng: 72.5847, city: 'amd' }, // Lal Darwaja, Ahmedabad
            'Maninagar': { lat: 23.0158, lng: 72.6064, city: 'amd' }, // Maninagar Railway Station
            'Naroda': { lat: 23.0732, lng: 72.6347, city: 'amd' }, // Naroda GIDC
            'Isanpur': { lat: 23.0295, lng: 72.6389, city: 'amd' }, // Isanpur Cross Roads
            'Vasna': { lat: 23.0074, lng: 72.5392, city: 'amd' }, // Vasna Bus Stand
            'Chandkheda': { lat: 23.1028, lng: 72.5564, city: 'amd' }, // Chandkheda Village
            'Chandkheda Gam': { lat: 23.1028, lng: 72.5564, city: 'amd' },
            'Ghuma': { lat: 23.0072, lng: 72.4897, city: 'amd' }, // Ghuma Village
            'Ghuma Gam': { lat: 23.0072, lng: 72.4897, city: 'amd' },
            'Odhav': { lat: 23.0419, lng: 72.6547, city: 'amd' }, // Odhav Industrial Area
            'Odhav Ring Road': { lat: 23.0419, lng: 72.6547, city: 'amd' },
            'SP Ring Road Approach': { lat: 23.0419, lng: 72.6547, city: 'amd' },
            'Ranip': { lat: 23.0919, lng: 72.5747, city: 'amd' }, // Ranip Village
            'Ranip Gam': { lat: 23.0919, lng: 72.5747, city: 'amd' },
            'Sabarmati': { lat: 23.0736, lng: 72.5806, city: 'amd' }, // Sabarmati Railway Station
            'Sarangpur': { lat: 23.0544, lng: 72.6031, city: 'amd' }, // Sarangpur
            'Gujarat University': { lat: 23.0644, lng: 72.5464, city: 'amd' }, // Gujarat University
            'Ashram Road': { lat: 23.0238, lng: 72.5703, city: 'amd' }, // Ashram Road
            'Ellis Bridge': { lat: 23.0353, lng: 72.5775, city: 'amd' }, // Ellis Bridge
            'C.G. Road': { lat: 23.0342, lng: 72.5564, city: 'amd' }, // CG Road
            'Paldi': { lat: 23.0089, lng: 72.5661, city: 'amd' }, // Paldi
            'Navrangpura': { lat: 23.0342, lng: 72.5564, city: 'amd' }, // Navrangpura
            
            // Ahmedabad BRT Stations - Verified Coordinates
            'ISKCON': { lat: 23.0297, lng: 72.5547, city: 'amd' }, // ISKCON Temple Ahmedabad
            'ISKCON Cross Road': { lat: 23.0297, lng: 72.5547, city: 'amd' },
            'Jaimangal': { lat: 23.0419, lng: 72.5947, city: 'amd' }, // Jaimangal Cross Roads
            'Narol': { lat: 22.9719, lng: 72.6347, city: 'amd' }, // Narol Village
            'Hanspura Ring Road': { lat: 23.0819, lng: 72.5247, city: 'amd' }, // Hanspura
            'LD Engg. College': { lat: 23.0719, lng: 72.5947, city: 'amd' }, // LD College of Engineering
            'Sarthi Bungalows': { lat: 23.1119, lng: 72.5147, city: 'amd' }, // Sarthi Bungalows
            'Sarthi Bunglows': { lat: 23.1119, lng: 72.5147, city: 'amd' },
            'Rabari Colony': { lat: 23.0919, lng: 72.6247, city: 'amd' }, // Rabari Colony
            'Chhipa Society': { lat: 23.0519, lng: 72.6147, city: 'amd' }, // Chhipa Society
            'Soma Textiles': { lat: 23.0319, lng: 72.6247, city: 'amd' }, // Soma Textiles
            'Kashiram Textiles': { lat: 23.0219, lng: 72.6347, city: 'amd' }, // Kashiram Textiles
            'Naroda S. T. Workshop': { lat: 23.0732, lng: 72.6347, city: 'amd' }, // Naroda ST Workshop
            'Amba Township': { lat: 23.1219, lng: 72.5047, city: 'amd' }, // Amba Township
            'Santej (Shah Alloys)': { lat: 23.2467, lng: 72.4564, city: 'amd' }, // Santej
            'Santej Gam': { lat: 23.2467, lng: 72.4564, city: 'amd' },
            'Arvind Polycoat (Khatraj)': { lat: 23.2089, lng: 72.5897, city: 'amd' }, // Khatraj
            'Vadaj': { lat: 23.0667, lng: 72.5833, city: 'amd' }, // Vadaj
            'G.E.B (Naroda)': { lat: 23.0732, lng: 72.6347, city: 'amd' }, // GEB Naroda
            'Kubadthal Gam': { lat: 23.1189, lng: 72.6564, city: 'amd' }, // Kubadthal
            'Arbudanagar': { lat: 23.0567, lng: 72.5789, city: 'amd' }, // Arbudanagar
            'Iskon Mandir': { lat: 23.0297, lng: 72.5547, city: 'amd' }, // ISKCON Temple
            'Madhavnagar (Sanand)': { lat: 22.9756, lng: 72.3869, city: 'amd' }, // Sanand
            'Gatrad Gam': { lat: 23.1456, lng: 72.4578, city: 'amd' }, // Gatrad
            'Raipur Darwaja': { lat: 23.0456, lng: 72.5678, city: 'amd' }, // Raipur Darwaja
            'Shilaj Gam': { lat: 23.1089, lng: 72.4567, city: 'amd' }, // Shilaj
            'Bhadrakali Mandir': { lat: 23.0189, lng: 72.5689, city: 'amd' }, // Bhadrakali Temple
            'Prakash Vidhyalay (Isanpur)': { lat: 23.0295, lng: 72.6389, city: 'amd' }, // Isanpur
            'Rancharda Gam': { lat: 23.0789, lng: 72.4234, city: 'amd' }, // Rancharda
            'Moti Bhoyan Chokdi': { lat: 23.0567, lng: 72.6234, city: 'amd' }, // Moti Bhoyan
            'Gandhinagar Institute Of Technology': { lat: 23.2156, lng: 72.6789, city: 'amd' }, // GIT Gandhinagar
            
            // Rajkot BRT & City Bus Stations - Verified Google Maps Coordinates
            'Trikon Baug': { lat: 22.3039, lng: 70.8022, city: 'rjkt' }, // Trikon Baug, Rajkot
            'Saurastra University': { lat: 22.2856, lng: 70.7792, city: 'rjkt' }, // Saurashtra University
            'Race Course': { lat: 22.2939, lng: 70.7922, city: 'rjkt' }, // Race Course Ground
            'Government Hospital': { lat: 22.3039, lng: 70.7922, city: 'rjkt' }, // Civil Hospital Rajkot
            'Railway Station': { lat: 22.3012, lng: 70.7869, city: 'rjkt' }, // Rajkot Junction
            'Rajkot Junction': { lat: 22.3012, lng: 70.7869, city: 'rjkt' },
            'Civil Hospital': { lat: 22.3039, lng: 70.7922, city: 'rjkt' },
            'Crystal Mall': { lat: 22.2839, lng: 70.7822, city: 'rjkt' }, // Crystal Mall Rajkot
            'Kalawad Road': { lat: 22.2739, lng: 70.7622, city: 'rjkt' }, // Kalawad Road
            'University Road': { lat: 22.2856, lng: 70.7792, city: 'rjkt' }, // University Road
            'Gondal Road': { lat: 22.3239, lng: 70.8222, city: 'rjkt' }, // Gondal Road
            'Morbi Road': { lat: 22.3339, lng: 70.8322, city: 'rjkt' }, // Morbi Road
            'Jetpur Road': { lat: 22.2939, lng: 70.7722, city: 'rjkt' }, // Jetpur Road
            'Rajkot Airport': { lat: 22.3092, lng: 70.7792, city: 'rjkt' }, // Rajkot Airport
            'ST Bus Stand': { lat: 22.3089, lng: 70.8056, city: 'rjkt' }, // ST Bus Stand Rajkot
            'Jubilee Garden': { lat: 22.2956, lng: 70.7956, city: 'rjkt' }, // Jubilee Garden
            'Yagnik Road': { lat: 22.2989, lng: 70.7889, city: 'rjkt' }, // Yagnik Road
            'Ramkrishna Ashram': { lat: 22.2889, lng: 70.7789, city: 'rjkt' }, // Ramkrishna Ashram
            
            // Surat BRT & City Bus Stations - Verified Google Maps Coordinates
            'UDHNA DARWAZA': { lat: 21.1591, lng: 72.7799, city: 'srt' }, // Udhna Darwaja, Surat
            'SACHIN G.I.D.C.': { lat: 21.0991, lng: 72.8899, city: 'srt' }, // Sachin GIDC
            'ONGC COLONY': { lat: 21.2191, lng: 72.8399, city: 'srt' }, // ONGC Colony Surat
            'SARTHANA NATURE PARK BRT': { lat: 21.2291, lng: 72.8199, city: 'srt' }, // Sarthana Nature Park
            'Surat Railway Station': { lat: 21.2051, lng: 72.8310, city: 'srt' }, // Surat Railway Station
            'Diamond Market': { lat: 21.1951, lng: 72.8210, city: 'srt' }, // Diamond Market Surat
            'Textile Market': { lat: 21.1851, lng: 72.8110, city: 'srt' }, // Textile Market
            'City Light': { lat: 21.2151, lng: 72.8410, city: 'srt' }, // City Light Area
            'Adajan': { lat: 21.2251, lng: 72.8510, city: 'srt' }, // Adajan
            'Vesu': { lat: 21.1451, lng: 72.7710, city: 'srt' }, // Vesu
            'Althan': { lat: 21.2351, lng: 72.8610, city: 'srt' }, // Althan
            'Katargam': { lat: 21.2451, lng: 72.8710, city: 'srt' }, // Katargam
            'Puna': { lat: 21.2551, lng: 72.8810, city: 'srt' }, // Puna
            'Varachha': { lat: 21.1751, lng: 72.8010, city: 'srt' }, // Varachha
            'Rander': { lat: 21.2389, lng: 72.8889, city: 'srt' }, // Rander
            'Magdalla': { lat: 21.1389, lng: 72.7889, city: 'srt' }, // Magdalla
            'Udhna': { lat: 21.1591, lng: 72.7799, city: 'srt' }, // Udhna
            'Nanpura': { lat: 21.1789, lng: 72.8189, city: 'srt' }, // Nanpura
            'Athwalines': { lat: 21.1989, lng: 72.8289, city: 'srt' } // Athwalines
        };

        // Enhanced coordinate mapping with comprehensive database and Google Maps fallback
        async function getStationCoordinates(stationName, cityCode) {
            const normalizedName = stationName.trim();
            const cityCodeUpper = cityCode.toUpperCase();
            
            // 1. Check our comprehensive coordinate database (highest priority)
            if (window.COMPLETE_STATION_COORDINATES && 
                window.COMPLETE_STATION_COORDINATES[cityCodeUpper] && 
                window.COMPLETE_STATION_COORDINATES[cityCodeUpper][normalizedName]) {
                
                const coords = window.COMPLETE_STATION_COORDINATES[cityCodeUpper][normalizedName];
                console.log(`Found in comprehensive database: ${stationName} at (${coords.lat}, ${coords.lng}) - ${coords.type}`);
                return {
                    lat: coords.lat,
                    lng: coords.lng,
                    city: cityCode,
                    source: 'comprehensive_database',
                    verified: coords.verified,
                    type: coords.type,
                    accuracy: coords.verified ? 'HIGH' : 'ESTIMATED'
                };
            }
            
            // 2. Check manual mapping as secondary fallback
            if (manualStationMapping[normalizedName]) {
                console.log(`Found manual coordinates for ${stationName}:`, manualStationMapping[normalizedName]);
                return {
                    ...manualStationMapping[normalizedName],
                    source: 'manual_mapping',
                    accuracy: 'HIGH'
                };
            }
            
            // 3. Check cache
            const cacheKey = `${stationName}_${cityCode}`;
            if (geocodingCache.has(cacheKey)) {
                return geocodingCache.get(cacheKey);
            }
            
            // 4. Use Google Maps Geocoding with enhanced queries
            const cityName = cityConfig[cityCode].name;
            const state = 'Gujarat, India';
            
            // Try multiple query variations for better accuracy
            const queryVariations = [
                `${stationName} Bus Station, ${cityName}, ${state}`,
                `${stationName} Transit Stop, ${cityName}, ${state}`,
                `${stationName}, ${cityName}, ${state}`,
                `${stationName} ${cityName === 'Ahmedabad' ? 'AMTS' : 'Bus Stand'}, ${cityName}, ${state}`
            ];
            
            for (let i = 0; i < queryVariations.length; i++) {
                const query = queryVariations[i];
                console.log(`Trying geocoding query ${i + 1}/${queryVariations.length}: ${query}`);
                
                try {
                    const geocoder = new google.maps.Geocoder();
                    const result = await new Promise((resolve, reject) => {
                        geocoder.geocode({ 
                            address: query,
                            region: 'IN', // India
                            bounds: getCityBounds(cityCode) // Restrict to city area
                        }, (results, status) => {
                            if (status === 'OK' && results.length > 0) {
                                resolve(results[0]);
                            } else {
                                reject(new Error(`Geocoding failed: ${status}`));
                            }
                        });
                    });
                    
                    const coordinates = {
                        lat: result.geometry.location.lat(),
                        lng: result.geometry.location.lng(),
                        city: cityCode,
                        source: 'google_geocoding',
                        query: query,
                        accuracy: result.geometry.location_type || 'APPROXIMATE'
                    };
                    
                    // Validate coordinates are within reasonable bounds for the city
                    if (isCoordinateValid(coordinates, cityCode)) {
                        console.log(`Successfully geocoded ${stationName}:`, coordinates);
                        // Cache the result
                        geocodingCache.set(cacheKey, coordinates);
                        return coordinates;
                    } else {
                        console.warn(`Geocoded coordinates for ${stationName} are outside city bounds`, coordinates);
                    }
                    
                } catch (error) {
                    console.warn(`Geocoding attempt ${i + 1} failed for ${stationName}:`, error);
                    continue; // Try next variation
                }
            }
            
            console.warn(`All geocoding attempts failed for ${stationName}, using fallback`);
            
            // Enhanced fallback to city center with intelligent positioning
            const city = cityConfig[cityCode];
            const fallbackCoords = generateIntelligentFallback(stationName, city, cityCode);
            
            // Cache the fallback result to avoid repeated attempts
            geocodingCache.set(cacheKey, fallbackCoords);
            return fallbackCoords;
        }
        
        // Get city bounds for geocoding restriction
        function getCityBounds(cityCode) {
            const cityBounds = {
                'amd': new google.maps.LatLngBounds(
                    new google.maps.LatLng(22.8, 72.3), // SW
                    new google.maps.LatLng(23.3, 72.8)  // NE
                ),
                'rjkt': new google.maps.LatLngBounds(
                    new google.maps.LatLng(22.2, 70.6), // SW
                    new google.maps.LatLng(22.4, 70.9)  // NE
                ),
                'srt': new google.maps.LatLngBounds(
                    new google.maps.LatLng(21.0, 72.6), // SW
                    new google.maps.LatLng(21.4, 73.0)  // NE
                )
            };
            return cityBounds[cityCode];
        }
        
        // Validate if coordinates are within reasonable city bounds
        function isCoordinateValid(coordinates, cityCode) {
            const bounds = getCityBounds(cityCode);
            const point = new google.maps.LatLng(coordinates.lat, coordinates.lng);
            return bounds.contains(point);
        }
        
        // Generate intelligent fallback coordinates based on station name patterns
        function generateIntelligentFallback(stationName, city, cityCode) {
            const lowerName = stationName.toLowerCase();
            let offsetLat = 0;
            let offsetLng = 0;
            let description = 'city center';
            
            // Intelligent positioning based on common station name patterns
            if (lowerName.includes('railway') || lowerName.includes('station') || lowerName.includes('junction')) {
                // Railway stations typically in central areas
                offsetLat = (Math.random() - 0.5) * 0.01;
                offsetLng = (Math.random() - 0.5) * 0.01;
                description = 'near railway area';
            } else if (lowerName.includes('airport')) {
                // Airports typically on outskirts
                offsetLat = (Math.random() - 0.5) * 0.05;
                offsetLng = (Math.random() - 0.5) * 0.05;
                description = 'airport area';
            } else if (lowerName.includes('university') || lowerName.includes('college')) {
                // Educational institutions
                offsetLat = (Math.random() - 0.5) * 0.02;
                offsetLng = (Math.random() - 0.5) * 0.02;
                description = 'educational area';
            } else if (lowerName.includes('hospital') || lowerName.includes('medical')) {
                // Medical facilities
                offsetLat = (Math.random() - 0.5) * 0.015;
                offsetLng = (Math.random() - 0.5) * 0.015;
                description = 'medical area';
            } else if (lowerName.includes('market') || lowerName.includes('mall') || lowerName.includes('shopping')) {
                // Commercial areas
                offsetLat = (Math.random() - 0.5) * 0.01;
                offsetLng = (Math.random() - 0.5) * 0.01;
                description = 'commercial area';
            } else if (lowerName.includes('gam') || lowerName.includes('village')) {
                // Villages typically on outskirts
                offsetLat = (Math.random() - 0.5) * 0.03;
                offsetLng = (Math.random() - 0.5) * 0.03;
                description = 'village area';
            } else if (lowerName.includes('road') || lowerName.includes('highway')) {
                // Major roads
                offsetLat = (Math.random() - 0.5) * 0.02;
                offsetLng = (Math.random() - 0.5) * 0.02;
                description = 'major road';
            } else {
                // General fallback
                offsetLat = (Math.random() - 0.5) * 0.02;
                offsetLng = (Math.random() - 0.5) * 0.02;
                description = 'estimated location';
            }
            
            return {
                lat: city.lat + offsetLat,
                lng: city.lng + offsetLng,
                city: cityCode,
                source: 'intelligent_fallback',
                description: description
            };
        }

        // Show route markers for a specific city with real coordinates
        async function showCityRoutes(cityCode) {
            // Clear existing route markers
            clearRouteMarkers();
            
            const cityRoutes = allRoutes.filter(r => r.city === cityCode);
            const city = cityConfig[cityCode];
            
            // Show loading indicator
            updateProgress(0, 'Loading station coordinates...');
            
            const uniqueStations = new Set();
            cityRoutes.forEach(route => {
                uniqueStations.add(route.from);
                uniqueStations.add(route.to);
            });
            
            console.log(`Loading coordinates for ${uniqueStations.size} unique stations in ${city.name}`);
            
            // Get coordinates for all unique stations
            const stationPromises = Array.from(uniqueStations).map(async (stationName, index) => {
                const progress = Math.round((index / uniqueStations.size) * 50);
                updateProgress(progress, `Geocoding ${stationName}...`);
                
                const coords = await getStationCoordinates(stationName, cityCode);
                stationCoordinates[`${stationName}_${cityCode}`] = coords;
                return coords;
            });
            
            await Promise.all(stationPromises);
            
            updateProgress(75, 'Creating route visualizations...');
            
            // Create route markers and paths
            for (let i = 0; i < cityRoutes.length; i++) {
                const route = cityRoutes[i];
                const fromCoords = stationCoordinates[`${route.from}_${cityCode}`];
                const toCoords = stationCoordinates[`${route.to}_${cityCode}`];
                
                if (fromCoords && toCoords) {
                    // Create route path
                    const routePath = new google.maps.Polyline({
                        path: [fromCoords, toCoords],
                        geodesic: true,
                        strokeColor: route.type === 'BRT' || route.type === 'BRTS' ? '#EF4444' : city.color,
                        strokeOpacity: 0.6,
                        strokeWeight: 3,
                        map: map
                    });
                    
                    routeMarkers.push(routePath);
                    
                    // Create start station marker
                    const startMarker = new google.maps.Marker({
                        position: fromCoords,
                        map: map,
                        title: `${route.from} (${route.routeCode})`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: route.type === 'BRT' || route.type === 'BRTS' ? '#EF4444' : city.color,
                            fillOpacity: 0.9,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                    
                    startMarker.addListener('click', () => {
                        showStationInfo(route.from, fromCoords, cityCode);
                    });
                    
                    routeMarkers.push(startMarker);
                    
                    // Create end station marker (if different from start)
                    if (route.from !== route.to) {
                        const endMarker = new google.maps.Marker({
                            position: toCoords,
                            map: map,
                            title: `${route.to} (${route.routeCode})`,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: route.type === 'BRT' || route.type === 'BRTS' ? '#EF4444' : city.color,
                                fillOpacity: 0.9,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });
                        
                        endMarker.addListener('click', () => {
                            showStationInfo(route.to, toCoords, cityCode);
                        });
                        
                        routeMarkers.push(endMarker);
                    }
                }
                
                // Update progress
                const progress = 75 + Math.round((i / cityRoutes.length) * 20);
                updateProgress(progress, `Creating route ${i + 1}/${cityRoutes.length}...`);
            }
            
            updateProgress(100, 'Route visualization complete!');
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 1000);
            
            updateVisibleRoutesCount();
        }
        
        // Show station information with coordinate details
        function showStationInfo(stationName, coordinates, cityCode) {
            const cityName = cityConfig[cityCode].name;
            const stationRoutes = allRoutes.filter(r => 
                r.city === cityCode && (r.from === stationName || r.to === stationName)
            );
            
            // Determine coordinate source icon and description
            let sourceIcon = 'üìç';
            let sourceText = 'Manual Database';
            let accuracyText = 'High Accuracy';
            let coordinateColor = 'text-green-600';
            
            if (coordinates.source === 'comprehensive_database') {
                sourceIcon = 'üóÑÔ∏è';
                sourceText = 'Comprehensive Database';
                accuracyText = coordinates.verified ? 'Verified Location' : 'Estimated Location';
                coordinateColor = coordinates.verified ? 'text-green-600' : 'text-blue-600';
                if (coordinates.type) {
                    accuracyText += ` (${coordinates.type.replace(/_/g, ' ')})`;
                }
            } else if (coordinates.source === 'manual_mapping') {
                sourceIcon = '‚úã';
                sourceText = 'Manual Database';
                accuracyText = 'High Accuracy';
                coordinateColor = 'text-green-600';
            } else if (coordinates.source === 'google_geocoding') {
                sourceIcon = 'üåê';
                sourceText = 'Google Maps';
                accuracyText = coordinates.accuracy === 'ROOFTOP' ? 'Precise' : 
                              coordinates.accuracy === 'RANGE_INTERPOLATED' ? 'Street Level' : 
                              coordinates.accuracy === 'GEOMETRIC_CENTER' ? 'Area Center' : 'Approximate';
                coordinateColor = coordinates.accuracy === 'ROOFTOP' ? 'text-green-600' : 'text-blue-600';
            } else if (coordinates.source === 'intelligent_fallback') {
                sourceIcon = 'üéØ';
                sourceText = 'Estimated Location';
                accuracyText = `Estimated (${coordinates.description || 'general area'})`;
                coordinateColor = 'text-orange-600';
            }
            
            const content = `
                <div class="info-window-content">
                    <h3 class="font-bold text-lg text-gray-800">${stationName}</h3>
                    <p class="text-sm text-gray-600 mb-2">${cityName} Transit Station</p>
                    <div class="space-y-1 text-sm">
                        <p><strong>Routes Served:</strong> ${stationRoutes.length}</p>
                        <p><strong>Route Numbers:</strong> ${[...new Set(stationRoutes.map(r => r.routeCode))].slice(0, 5).join(', ')}${stationRoutes.length > 5 ? '...' : ''}</p>
                        <p><strong>Service Types:</strong> ${[...new Set(stationRoutes.map(r => r.type))].join(', ')}</p>
                        <hr class="my-2">
                        <p class="${coordinateColor}"><strong>${sourceIcon} Location Source:</strong> ${sourceText}</p>
                        <p class="${coordinateColor}"><strong>üìê Accuracy:</strong> ${accuracyText}</p>
                        <p class="text-gray-500 text-xs"><strong>Coordinates:</strong> ${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}</p>
                        ${coordinates.query ? `<p class="text-gray-400 text-xs"><strong>Search Query:</strong> ${coordinates.query}</p>` : ''}
                    </div>
                    <div class="mt-3 pt-2 border-t border-gray-200">
                        <button onclick="focusOnStation('${stationName}', ${coordinates.lat}, ${coordinates.lng})" 
                                class="mr-2 px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                            Center Map
                        </button>
                        <button onclick="showStationRoutes('${stationName}', '${cityCode}')" 
                                class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                            Show All Routes
                        </button>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.setPosition(coordinates);
            infoWindow.open(map);
        }
        
        // Focus map on specific station
        function focusOnStation(stationName, lat, lng) {
            map.setCenter({ lat: lat, lng: lng });
            map.setZoom(15);
        }
        
        // Show all routes for a specific station
        function showStationRoutes(stationName, cityCode) {
            const stationRoutes = allRoutes.filter(r => 
                r.city === cityCode && (r.from === stationName || r.to === stationName)
            );
            
            // Clear existing route highlights
            clearHighlightedRoute();
            
            // Highlight all routes passing through this station
            stationRoutes.forEach((route, index) => {
                const fromCoords = stationCoordinates[`${route.from}_${route.city}`];
                const toCoords = stationCoordinates[`${route.to}_${route.city}`];
                
                if (fromCoords && toCoords) {
                    setTimeout(() => {
                        const routePath = new google.maps.Polyline({
                            path: [fromCoords, toCoords],
                            geodesic: true,
                            strokeColor: route.type === 'BRT' || route.type === 'BRTS' ? '#EF4444' : '#FFD700',
                            strokeOpacity: 0.8,
                            strokeWeight: 4,
                            map: map,
                            zIndex: 1000 + index
                        });
                        
                        if (!highlightedRoute) highlightedRoute = [];
                        if (Array.isArray(highlightedRoute)) {
                            highlightedRoute.push(routePath);
                        } else {
                            highlightedRoute = [routePath];
                        }
                    }, index * 100); // Staggered animation
                }
            });
            
            // Show route count message
            const message = `Highlighting ${stationRoutes.length} routes for ${stationName}`;
            console.log(message);
            
            // Update route details panel
            document.getElementById('route-details').innerHTML = 
                `<div class="border-l-4 border-blue-500 pl-4">
                    <h4 class="font-semibold text-lg">${stationName} Station</h4>
                    <p class="text-gray-600 mb-3">Route Analysis</p>
                    <div class="space-y-2 text-sm">
                        <p><strong>Total Routes:</strong> ${stationRoutes.length}</p>
                        <p><strong>Route Types:</strong> ${[...new Set(stationRoutes.map(r => r.type))].join(', ')}</p>
                        <p><strong>Route Numbers:</strong> ${[...new Set(stationRoutes.map(r => r.routeCode))].join(', ')}</p>
                        <p><strong>Connections:</strong> ${[...new Set(stationRoutes.flatMap(r => [r.from, r.to]).filter(s => s !== stationName))].length} different destinations</p>
                    </div>
                </div>`;
        }

        // Show route information
        function showRouteInfo(route, marker) {
            const cityName = cityConfig[route.city].name;
            
            const content = `
                <div class="info-window-content">
                    <h3 class="font-bold text-lg text-gray-800">${route.routeCode}</h3>
                    <p class="text-sm text-gray-600 mb-2">${cityName} - ${route.type} Route</p>
                    <div class="space-y-1 text-sm">
                        <p><strong>From:</strong> ${route.from}</p>
                        <p><strong>To:</strong> ${route.to}</p>
                        <p><strong>Service Hours:</strong> ${route.startTime} - ${route.endTime}</p>
                        <p><strong>Type:</strong> ${route.type}</p>
                        <button onclick="showFullRoute('${route.id}')" 
                                class="mt-2 px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                            Show Full Route
                        </button>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
            
            // Update route details panel
            showRouteDetails(route);
        }
        
        // Show full route with highlighted path
        function showFullRoute(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;
            
            const fromCoords = stationCoordinates[`${route.from}_${route.city}`];
            const toCoords = stationCoordinates[`${route.to}_${route.city}`];
            
            if (fromCoords && toCoords) {
                // Clear existing highlighted routes
                clearHighlightedRoute();
                
                // Create highlighted route path
                highlightedRoute = new google.maps.Polyline({
                    path: [fromCoords, toCoords],
                    geodesic: true,
                    strokeColor: '#FFD700',
                    strokeOpacity: 0.9,
                    strokeWeight: 6,
                    map: map
                });
                
                // Adjust map bounds to show full route
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(fromCoords);
                bounds.extend(toCoords);
                map.fitBounds(bounds);
                
                // Add padding
                setTimeout(() => {
                    map.setZoom(Math.max(map.getZoom() - 1, 10));
                }, 100);
            }
        }
        
        // Clear highlighted route(s)
        function clearHighlightedRoute() {
            if (highlightedRoute) {
                if (Array.isArray(highlightedRoute)) {
                    highlightedRoute.forEach(route => {
                        if (route && route.setMap) {
                            route.setMap(null);
                        }
                    });
                    highlightedRoute = [];
                } else {
                    if (highlightedRoute.setMap) {
                        highlightedRoute.setMap(null);
                    }
                    highlightedRoute = null;
                }
            }
        }

        // Clear all route markers
        function clearRouteMarkers() {
            routeMarkers.forEach(marker => {
                marker.setMap(null);
            });
            routeMarkers = [];
            
            // Also clear highlighted routes
            clearHighlightedRoute();
        }

        // Setup map type controls
        function setupMapControls() {
            document.getElementById('map-type-roadmap').addEventListener('click', () => {
                map.setMapTypeId('roadmap');
                updateMapTypeButtons('roadmap');
            });

            document.getElementById('map-type-satellite').addEventListener('click', () => {
                map.setMapTypeId('satellite');
                updateMapTypeButtons('satellite');
            });

            document.getElementById('map-type-terrain').addEventListener('click', () => {
                map.setMapTypeId('terrain');
                updateMapTypeButtons('terrain');
            });
        }

        // Update map type button styles
        function updateMapTypeButtons(activeType) {
            ['roadmap', 'satellite', 'terrain'].forEach(type => {
                const button = document.getElementById(`map-type-${type}`);
                if (type === activeType) {
                    button.className = 'px-3 py-1 bg-blue-500 text-white rounded text-sm';
                } else {
                    button.className = 'px-3 py-1 bg-gray-500 text-white rounded text-sm';
                }
            });
        }

        // Update visible routes count
        function updateVisibleRoutesCount() {
            document.getElementById('visible-routes-count').textContent = routeMarkers.length;
        }

        // Load unified transit data from JSON file
        let unifiedTransitData = null;
        
        // Function to load JSON data
        async function loadTransitData() {
            try {
                const response = await fetch('./unified_transit_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                unifiedTransitData = await response.json();
                console.log('Loaded transit data:', unifiedTransitData);
                return unifiedTransitData;
            } catch (error) {
                console.error('Error loading transit data:', error);
                // Fallback to mock data if JSON file is not available
                return createMockData();
            }
        }
        
        // Fallback mock data structure (smaller version for testing)
        function createMockData() {
            return {
                metadata: {
                    title: "Gujarat Transit Systems Data (Mock)",
                    cities_included: ["Ahmedabad", "Rajkot", "Surat"]
                },
                cities: {
                    ahmedabad: {
                        city_name: "Ahmedabad",
                        city_code: "AMD",
                        transit_systems: {
                            AMTS: {
                                system_name: "Ahmedabad Municipal Transport Service",
                                system_type: "City Bus",
                                routes: [
                                    { routeCode: "65/2", startName: "Santej", endName: "Lal Darwaja", startTime: "06:50:00", endTime: "19:45:00", linetype: "AMTS" },
                                    { routeCode: "144", startName: "Gujarat University", endName: "Arbudanagar", startTime: "07:15:00", endTime: "20:30:00", linetype: "AMTS" }
                                ]
                            },
                            BRT: {
                                system_name: "Bus Rapid Transit System",
                                system_type: "BRT",
                                routes: [
                                    { routeCode: "1D", startName: "Maninagar", endName: "Ghuma Gam", startTime: "06:00:00", endTime: "22:45:00", linetype: "BRTS" },
                                    { routeCode: "2D", startName: "Odhav Ring Road", endName: "ISKCON", startTime: "06:00:00", endTime: "22:45:00", linetype: "BRTS" }
                                ]
                            }
                        }
                    },
                    rajkot: {
                        city_name: "Rajkot",
                        city_code: "RJKT",
                        transit_systems: {
                            BRT: {
                                system_name: "Rajkot Mass Transport Service",
                                system_type: "BRT",
                                routes: [
                                    { Bus_Number: "1", Origin_Stop: "Saurastra University", Destination_Stop: "Trikon Baug" },
                                    { Bus_Number: "7", Origin_Stop: "Bajrangvadi Circle", Destination_Stop: "Bhaktinagar Circle" }
                                ]
                            }
                        }
                    },
                    surat: {
                        city_name: "Surat",
                        city_code: "SRT",
                        transit_systems: {
                            BRT_Clean: {
                                system_name: "SITILINK Cleaned Data",
                                system_type: "BRT",
                                routes: [
                                    { Service_No: "11", Origin_Stop: "UDHNA DARWAZA", Destination_Stop: "SACHIN G.I.D.C.", Vehicle_Type: "BRT" },
                                    { Service_No: "12", Origin_Stop: "ONGC COLONY", Destination_Stop: "SARTHANA NATURE PARK BRT", Vehicle_Type: "BRT" }
                                ]
                            }
                        }
                    }
                }
            };
        }

        // Initialize application
        async function init() {
            updateProgress(10, 'Loading transit data...');
            
            // Load JSON data first
            await loadTransitData();
            
            updateProgress(30, 'Parsing transit routes...');
            parseAllData();
            
            updateProgress(60, 'Creating visualizations...');
            setupEventListeners();
            
            updateProgress(80, 'Finalizing interface...');
            updateStatistics();
            populateRouteTable();
            
            updateProgress(100, 'Ready!');
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            }, 1000);
        }

        // Parse all transit data from JSON
        function parseAllData() {
            if (!unifiedTransitData) {
                console.error('No transit data available');
                return;
            }

            // Parse Ahmedabad data
            if (unifiedTransitData.cities.ahmedabad) {
                const amdCity = unifiedTransitData.cities.ahmedabad;
                
                // Parse AMTS routes
                if (amdCity.transit_systems.AMTS && amdCity.transit_systems.AMTS.routes) {
                    amdCity.transit_systems.AMTS.routes.forEach((route, index) => {
                        if (route.startName && route.endName) {
                            allRoutes.push({
                                id: 'amd-amts-' + index,
                                city: 'amd',
                                routeCode: route.routeCode || route.customerRouteCode || 'N/A',
                                from: route.startName,
                                to: route.endName,
                                type: 'AMTS',
                                startTime: route.startTime || '06:00:00',
                                endTime: route.endTime || '22:00:00'
                            });
                        }
                    });
                }

                // Parse BRT routes
                if (amdCity.transit_systems.BRT && amdCity.transit_systems.BRT.routes) {
                    amdCity.transit_systems.BRT.routes.forEach((route, index) => {
                        if (route.startName && route.endName) {
                            allRoutes.push({
                                id: 'amd-brt-' + index,
                                city: 'amd',
                                routeCode: route.routeCode || route.customerRouteCode || 'N/A',
                                from: route.startName,
                                to: route.endName,
                                type: 'BRT',
                                startTime: route.startTime || '06:00:00',
                                endTime: route.endTime || '22:00:00'
                            });
                        }
                    });
                }
            }

            // Parse Rajkot data
            if (unifiedTransitData.cities.rajkot) {
                const rjktCity = unifiedTransitData.cities.rajkot;
                
                if (rjktCity.transit_systems.BRT && rjktCity.transit_systems.BRT.routes) {
                    const uniqueRjktRoutes = new Map();
                    rjktCity.transit_systems.BRT.routes.forEach(route => {
                        if (route.Origin_Stop && route.Destination_Stop) {
                            const key = route.Bus_Number + '-' + route.Origin_Stop + '-' + route.Destination_Stop;
                            if (!uniqueRjktRoutes.has(key)) {
                                uniqueRjktRoutes.set(key, {
                                    id: 'rjkt-' + route.Route_ID,
                                    city: 'rjkt',
                                    routeCode: route.Bus_Number || 'N/A',
                                    from: route.Origin_Stop,
                                    to: route.Destination_Stop,
                                    type: 'BRT',
                                    startTime: '06:00:00',
                                    endTime: '22:00:00'
                                });
                            }
                        }
                    });
                    uniqueRjktRoutes.forEach(route => allRoutes.push(route));
                }
            }

            // Parse Surat data
            if (unifiedTransitData.cities.surat) {
                const srtCity = unifiedTransitData.cities.surat;
                
                // Try different system names that might exist
                const systemNames = ['BRT', 'BRT_Clean', 'BRT_Raw'];
                systemNames.forEach(systemName => {
                    if (srtCity.transit_systems[systemName] && srtCity.transit_systems[systemName].routes) {
                        srtCity.transit_systems[systemName].routes.forEach((route, index) => {
                            if (route.Origin_Stop && route.Destination_Stop) {
                                allRoutes.push({
                                    id: 'srt-' + systemName + '-' + index,
                                    city: 'srt',
                                    routeCode: route.Service_No || route.Service_Type || 'N/A',
                                    from: route.Origin_Stop,
                                    to: route.Destination_Stop,
                                    type: route.Vehicle_Type || 'BRT',
                                    startTime: '06:00:00',
                                    endTime: '22:00:00'
                                });
                            }
                        });
                    }
                });
            }

            console.log('Parsed routes:', allRoutes.length);
        }

        // Setup event listeners
        function setupEventListeners() {
            // City toggle buttons
            document.querySelectorAll('[data-city]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const city = e.target.dataset.city;
                    focusCity(city);
                });
            });

            // Search functionality
            document.getElementById('search-routes').addEventListener('input', (e) => {
                searchRoutes(e.target.value);
            });

            // City filter
            document.getElementById('city-filter').addEventListener('change', (e) => {
                populateRouteTable(e.target.value);
            });
        }

        // Focus on a specific city
        function focusCity(cityCode) {
            const city = cityConfig[cityCode];
            
            // Center map on city
            map.setCenter({ lat: city.lat, lng: city.lng });
            map.setZoom(11);
            
            // Show routes for this city
            showCityRoutes(cityCode);
            
            // Update route details panel
            const cityRoutes = allRoutes.filter(r => r.city === cityCode);
            document.getElementById('route-details').innerHTML = 
                '<div class="border-l-4 border-' + (cityCode === 'amd' ? 'blue' : cityCode === 'rjkt' ? 'green' : 'purple') + '-500 pl-4">' +
                '<h4 class="font-semibold text-lg">' + city.name + '</h4>' +
                '<p class="text-gray-600 mb-3">Transit System Overview</p>' +
                '<div class="space-y-2 text-sm">' +
                '<p><strong>Total Routes:</strong> ' + cityRoutes.length + '</p>' +
                '<p><strong>Service Types:</strong> ' + [...new Set(cityRoutes.map(r => r.type))].join(', ') + '</p>' +
                '<p><strong>Operating Hours:</strong> 05:00 - 23:00</p>' +
                '<p><strong>Coverage:</strong> City-wide network</p>' +
                '</div>' +
                '</div>';
        }

        // Search routes with pagination support
        function searchRoutes(query) {
            if (!query.trim()) {
                // If search is empty, repopulate with current filter
                const cityFilter = document.getElementById('city-filter').value;
                populateRouteTable(cityFilter);
                return;
            }
            
            // Filter routes based on search query
            const cityFilter = document.getElementById('city-filter').value;
            const baseRoutes = allRoutes.filter(route => {
                return cityFilter === 'all' || route.city === cityFilter;
            });
            
            currentFilteredRoutes = baseRoutes.filter(route => {
                const searchText = query.toLowerCase();
                return route.routeCode.toLowerCase().includes(searchText) ||
                       route.from.toLowerCase().includes(searchText) ||
                       route.to.toLowerCase().includes(searchText) ||
                       route.type.toLowerCase().includes(searchText) ||
                       cityConfig[route.city].name.toLowerCase().includes(searchText);
            });
            
            currentPage = 1; // Reset to first page
            renderTablePage();
            updatePaginationInfo();
        }

        // Update statistics
        function updateStatistics() {
            const amdRoutes = allRoutes.filter(r => r.city === 'amd');
            const rjktRoutes = allRoutes.filter(r => r.city === 'rjkt');
            const srtRoutes = allRoutes.filter(r => r.city === 'srt');
            
            const brtRoutes = allRoutes.filter(r => r.type === 'BRT' || r.type === 'BRTS');
            const amtsRoutes = allRoutes.filter(r => r.type === 'AMTS');
            const cityRoutes = allRoutes.filter(r => r.type === 'City');

            // Update main stats with null checks
            const totalRoutesEl = document.getElementById('total-routes');
            if (totalRoutesEl) totalRoutesEl.textContent = allRoutes.length;
            
            const amdCountEl = document.getElementById('amd-count');
            if (amdCountEl) amdCountEl.textContent = amdRoutes.length;
            
            const rjktCountEl = document.getElementById('rjkt-count');
            if (rjktCountEl) rjktCountEl.textContent = rjktRoutes.length;
            
            const srtCountEl = document.getElementById('srt-count');
            if (srtCountEl) srtCountEl.textContent = srtRoutes.length;

            // Update quick stats with null checks
            const brtCountEl = document.getElementById('brt-count');
            if (brtCountEl) brtCountEl.textContent = brtRoutes.length;
            
            const amtsCountEl = document.getElementById('amts-count');
            if (amtsCountEl) amtsCountEl.textContent = amtsRoutes.length;
            
            const cityCountEl = document.getElementById('city-count');
            if (cityCountEl) cityCountEl.textContent = cityRoutes.length;
        }

        // Pagination variables
        let currentPage = 1;
        let routesPerPage = 50;
        let currentFilteredRoutes = [];

        // Populate route table
        function populateRouteTable(cityFilter = 'all') {
            const tableBody = document.getElementById('route-table-body');
            
            currentFilteredRoutes = allRoutes.filter(route => {
                return cityFilter === 'all' || route.city === cityFilter;
            });

            // Reset to first page when filter changes
            currentPage = 1;
            
            // Update pagination info
            updatePaginationInfo();
            
            // Render current page
            renderTablePage();
        }

        // Render specific page of routes
        function renderTablePage() {
            const tableBody = document.getElementById('route-table-body');
            tableBody.innerHTML = '';

            const startIndex = (currentPage - 1) * routesPerPage;
            const endIndex = Math.min(startIndex + routesPerPage, currentFilteredRoutes.length);
            const pageRoutes = currentFilteredRoutes.slice(startIndex, endIndex);

            pageRoutes.forEach(route => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showRouteDetails(route);
                
                row.innerHTML = 
                    '<td class="px-6 py-4">' +
                    '<span class="px-3 py-1 text-xs font-semibold rounded-full ' + getCityBadgeClass(route.city) + '">' +
                    cityConfig[route.city].name + '</span></td>' +
                    '<td class="px-6 py-4 font-medium">' + route.routeCode + '</td>' +
                    '<td class="px-6 py-4 text-sm text-gray-600">' + route.from + '</td>' +
                    '<td class="px-6 py-4 text-sm text-gray-600">' + route.to + '</td>' +
                    '<td class="px-6 py-4">' +
                    '<span class="px-3 py-1 text-xs font-semibold rounded-full ' + getTypeBadgeClass(route.type) + '">' +
                    route.type + '</span></td>' +
                    '<td class="px-6 py-4 text-sm">' + route.startTime + ' - ' + route.endTime + '</td>';
                
                tableBody.appendChild(row);
            });
        }

        // Update pagination information
        function updatePaginationInfo() {
            const totalRoutes = currentFilteredRoutes.length;
            const totalPages = Math.ceil(totalRoutes / routesPerPage);
            const startIndex = (currentPage - 1) * routesPerPage + 1;
            const endIndex = Math.min(currentPage * routesPerPage, totalRoutes);

            // Update pagination display
            const paginationInfo = document.getElementById('pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalRoutes} routes`;
            }

            // Update page buttons
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');

            if (prevButton) prevButton.disabled = currentPage === 1;
            if (nextButton) nextButton.disabled = currentPage === totalPages;

            // Generate page numbers
            if (pageNumbers) {
                let pageNumbersHTML = '';
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage < maxVisiblePages - 1) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage;
                    pageNumbersHTML += `
                        <button onclick="goToPage(${i})" 
                                class="px-3 py-1 mx-1 text-sm rounded ${isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                            ${i}
                        </button>
                    `;
                }
                pageNumbers.innerHTML = pageNumbersHTML;
            }
        }

        // Navigation functions
        function goToPage(page) {
            currentPage = page;
            renderTablePage();
            updatePaginationInfo();
        }

        function previousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(currentFilteredRoutes.length / routesPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        // Change routes per page
        function changeRoutesPerPage(value) {
            if (value === 'all') {
                routesPerPage = currentFilteredRoutes.length;
            } else {
                routesPerPage = parseInt(value);
            }
            currentPage = 1; // Reset to first page
            renderTablePage();
            updatePaginationInfo();
        }

        // Global functions for pagination controls
        window.goToPage = goToPage;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.changeRoutesPerPage = changeRoutesPerPage;

        // Show route details
        function showRouteDetails(route) {
            const cityName = cityConfig[route.city].name;
            document.getElementById('route-details').innerHTML = 
                '<div class="border-l-4 border-blue-500 pl-4">' +
                '<h4 class="font-semibold text-lg">' + route.routeCode + '</h4>' +
                '<p class="text-gray-600 mb-3">' + cityName + ' - ' + route.type + ' Route</p>' +
                '<div class="space-y-2 text-sm">' +
                '<p><strong>From:</strong> ' + route.from + '</p>' +
                '<p><strong>To:</strong> ' + route.to + '</p>' +
                '<p><strong>Service Hours:</strong> ' + route.startTime + ' - ' + route.endTime + '</p>' +
                '<p><strong>Route Type:</strong> ' + route.type + '</p>' +
                '</div>' +
                '</div>';
        }

        // Helper functions
        function getCityBadgeClass(city) {
            const classes = {
                'amd': 'bg-blue-100 text-blue-800',
                'rjkt': 'bg-green-100 text-green-800',
                'srt': 'bg-purple-100 text-purple-800'
            };
            return classes[city] || 'bg-gray-100 text-gray-800';
        }

        function getTypeBadgeClass(type) {
            const classes = {
                'BRT': 'bg-red-100 text-red-800',
                'BRTS': 'bg-red-100 text-red-800',
                'AMTS': 'bg-blue-100 text-blue-800',
                'City': 'bg-purple-100 text-purple-800'
            };
            return classes[type] || 'bg-gray-100 text-gray-800';
        }

        function updateProgress(percent, status) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('loading-status').textContent = status;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 500);
        });

        // Global function for zoom to city (called from info window)
        window.zoomToCity = function(cityCode) {
            focusCity(cityCode);
            if (typeof infoWindow !== 'undefined') {
                infoWindow.close();
            }
        };
    </script>

    <!-- Google Maps API Integration -->
    <script>
        // Fallback for when Google Maps API is not available
        if (typeof google === 'undefined') {
            // Create a placeholder map with instructions
            document.addEventListener('DOMContentLoaded', () => {
                const mapElement = document.getElementById('map');
                mapElement.innerHTML = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg">
                        <div class="text-center p-8">
                            <div class="text-6xl mb-4">üó∫Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Interactive Map Ready</h3>
                            <p class="text-gray-600 mb-4">Add your API key to enable real map functionality</p>
                            
                            <div class="bg-white rounded-lg p-4 shadow-lg max-w-md mx-auto mb-6">
                                <h4 class="font-semibold mb-3 text-gray-800">üîë API Setup Instructions:</h4>
                                <div class="text-sm text-left space-y-2">
                                    <div class="p-2 bg-blue-50 rounded">
                                        <strong>For Google Maps:</strong><br>
                                        1. Get API key from Google Cloud Console<br>
                                        2. Enable Maps JavaScript API<br>
                                        3. Replace YOUR_API_KEY in script tag below
                                    </div>
                                    <div class="p-2 bg-green-50 rounded">
                                        <strong>For MapMyIndia (Mappls):</strong><br>
                                        1. Get API key from Mappls Console<br>
                                        2. Better for Indian locations<br>
                                        3. Use alternative script tag below
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-blue-100 p-3 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors" onclick="focusCity('amd')">
                                    <div class="w-4 h-4 bg-blue-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-xs font-medium">Ahmedabad</div>
                                    <div class="text-xs text-gray-600">Click to view</div>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg cursor-pointer hover:bg-green-200 transition-colors" onclick="focusCity('rjkt')">
                                    <div class="w-4 h-4 bg-green-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-xs font-medium">Rajkot</div>
                                    <div class="text-xs text-gray-600">Click to view</div>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg cursor-pointer hover:bg-purple-200 transition-colors" onclick="focusCity('srt')">
                                    <div class="w-4 h-4 bg-purple-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-xs font-medium">Surat</div>
                                    <div class="text-xs text-gray-600">Click to view</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    </script>

    <!-- 
    üó∫Ô∏è MAP API INTEGRATION OPTIONS:
    
    Option 1: Google Maps (Recommended for global coverage)
    Replace YOUR_GOOGLE_MAPS_API_KEY with your actual Google Maps API key from console.cloud.google.com
    -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBl1n3-mCaJDrXqeqnR0HhguZAENPdgg88&callback=initMap"></script>
    
    <!-- 
    Option 2: MapMyIndia/Mappls (Recommended for Indian locations - better local data)
    Replace YOUR_MAPPLS_API_KEY with your actual Mappls API key from about.mappls.com
    -->
    <!-- <script src="https://apis.mappls.com/advancedmaps/api/YOUR_MAPPLS_API_KEY/map_sdk?layer=vector&v=3.0&callback=initMap"></script> -->
    
    <!--
    üîß SETUP INSTRUCTIONS:
    
    1. Choose your preferred map provider above
    2. Get an API key from the respective platform
    3. Uncomment the appropriate script tag
    4. Replace the placeholder API key with your real key
    5. The map will automatically load with all transit routes!
    
    üí° For this demo, the fallback placeholder map shows all the data and functionality
    -->
</body>
</html>